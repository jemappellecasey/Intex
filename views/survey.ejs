<%# 3-12 | Hirohito Mizuno, Casey Black, Hector Casablanca, Karie Ward %>
<%# We made this survey page so participants can fill post-event scores and comments. %>
<!-- This is the page to host the surveys. It will pull the information from the survey they clicked to review. (EventName, EventDateTimeStart, EventLocation) -->
 <!-- Buttons for SurveySatisfactionScore	SurveyUsefulnessScore	SurveyInstructorScore	SurveyRecommendationScore, 1-5 (labeled) -->


 <!DOCTYPE html>
<html lang="en">
<head>
  <title>Post-Event Surveys</title>
  <%- include('partials/head') %>
</head>
<body>
<div class="layout">
  <%- include('partials/userbar') %>
  <aside class="sidebar">
    <div class="sidebar-brand">
      <a href="/dashboard" aria-label="Back to dashboard">
        <img src="/images/logo.png" alt="Ella Rises logo" class="brand-logo">
      </a>
    </div>
    <h2>Menu</h2>
    <nav>
      <a href="/dashboard">Dashboard</a>
      <a href="/participants">Participants</a>
      <a href="/events">Events</a>
      <a href="/surveys" class="active">Surveys</a>
      <a href="/milestones">Milestones</a>
      <a href="/donations">Donations</a>
      <% if (isManager) { %>
        <hr>
        <a href="/admin/settings">Admin Settings</a>
      <% } %>
    </nav>
  </aside>
<main class="main-content">

<h1>Post-Event Surveys</h1>

<!-- Error message -->
<% if (error_message) { %>
  <div class="alert alert-error"><%= error_message %></div>
<% } %>
<% if (typeof success_message !== 'undefined' && success_message) { %>
  <div class="alert alert-success" id="survey-success" data-success="<%= success_message %>"><%= success_message %></div>
  <script>
    window.addEventListener('DOMContentLoaded', function () {
      var el = document.getElementById('survey-success');
      if (el && el.dataset && el.dataset.success) {
        alert(el.dataset.success);
        var params = new URLSearchParams(window.location.search);
        if (params.get('saved') === '1') {
          params.delete('saved');
          var newQuery = params.toString();
          var newUrl = window.location.pathname + (newQuery ? '?' + newQuery : '');
          window.history.replaceState({}, document.title, newUrl);
        }
      }
    });
  </script>
<% } %>

<hr>

<!-- ============================= -->
<!-- SEARCH / FILTER SECTION       -->
<!-- ============================= -->
<% if (isManager) { %>
  <div class="page-actions">
    <a href="/surveys/new">
      <button type="button">Add New Survey</button>
    </a>
  </div>

  <section>
    <h2 class="centered-title">Search Surveys</h2>

    <!-- GET so that paging links can keep the same filters -->
    <form method="get" action="/surveys" class="filter-form">
      <div class="filter-stack">
        <div class="compact-field">
          <label>
            Event Name:
            <input type="text" name="eventName" value="<%= eventName || '' %>">
          </label>
        </div>

        <div class="compact-field">
          <label>
            Participant Name:
            <input type="text" name="participantName" value="<%= participantName || '' %>">
          </label>
        </div>
      </div>

      <div class="date-range">
        <div class="date-field">
          <label>From Date</label>
          <input type="date" name="startDate" value="<%= startDate || '' %>">
        </div>
        <div class="date-field">
          <label>To Date</label>
          <input type="date" name="endDate" value="<%= endDate || '' %>">
        </div>
      </div>

      <div class="filter-actions">
        <button type="submit">Search</button>
      </div>
    </form>
  </section>

  <hr>
<% } %>

<!-- ============================= -->
<!-- ADMIN VIEW: SURVEY LIST       -->
<!-- ============================= -->
<% if (isManager) { %>
<section>
  <h2 class="centered-title">Survey List</h2>

  <% if (!surveys || surveys.length === 0) { %>
    <p>No surveys found.</p>
  <% } else { %>
    <div class="table-responsive">
      <table class="surveys-table">
        <thead>
          <tr>
            <th>Event Name</th>
            <th>Event Start</th>
            <th>Location</th>
            <th>Participant</th>
            <th>Satisfaction</th>
            <th>Usefulness</th>
            <th>Instructor</th>
            <th>Recommendation</th>
            <th>Overall</th>
            <th>Attendance</th>
            <th>Submitted At</th>
            <% if (isManager) { %>
              <th>Actions</th>
            <% } %>
          </tr>
        </thead>

        <tbody>
        <% surveys.forEach(function(s) { %>
          <tr>
            <td><%= s.eventname %></td>

            <td>
              <% if (s.eventdatetimestart) { %>
                <%= new Date(s.eventdatetimestart).toLocaleString() %>
              <% } else { %> N/A <% } %>
            </td>

            <td><%= s.eventlocation || 'N/A' %></td>

            <td>
              <%= s.participantfirstname || '' %>
              <%= s.participantlastname || '' %>
            </td>

            <td><%= s.surveysatisfactionscore %></td>
            <td><%= s.surveyusefulnessscore %></td>
            <td><%= s.surveyinstructorscore %></td>
            <td><%= s.surveyrecommendationscore %></td>
            <td><%= s.surveyoverallscore %></td>
            <td>
              <% if (typeof s.registrationattendanceflag !== 'undefined' && s.registrationattendanceflag !== null) { %>
                <%= s.registrationattendanceflag ? 'Yes' : 'No' %>
              <% } else { %>
                N/A
              <% } %>
            </td>

            <td>
              <% if (s.surveysubmissiondate) { %>
                <%= new Date(s.surveysubmissiondate).toLocaleString() %>
              <% } else { %> N/A <% } %>
            </td>

            <% if (isManager) { %>
            <td>
              <!-- Edit button (manager only) -->
              <a href="/surveys/<%= s.surveyid %>/edit">
                <button type="button">Edit</button>
              </a>

              <!-- Delete button (manager only) -->
              <form method="post"
                    action="/surveys/<%= s.surveyid %>/delete"
                    style="display:inline;"
                    onsubmit="return confirm('Are you sure you want to delete this survey?');">
                <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                <button type="submit">Delete</button>
              </form>
            </td>
            <% } %>
          </tr>
        <% }); %>
        </tbody>
      </table>
    </div>
  <% } %>

  <div class="pagination pagination-centered">
    <% if (currentPage > 1) { %>
      <a class="btn secondary-btn" href="/surveys?page=<%= currentPage - 1 %>
        &eventName=<%= encodeURIComponent(eventName || '') %>
        &participantName=<%= encodeURIComponent(participantName || '') %>
        &startDate=<%= startDate || '' %>
        &endDate=<%= endDate || '' %>">
        Prev
      </a>
    <% } %>

    <span>Page <%= currentPage %> of <%= totalPages %></span>

    <% if (currentPage < totalPages) { %>
      <a class="btn secondary-btn" href="/surveys?page=<%= currentPage + 1 %>
        &eventName=<%= encodeURIComponent(eventName || '') %>
        &participantName=<%= encodeURIComponent(participantName || '') %>
        &startDate=<%= startDate || '' %>
        &endDate=<%= endDate || '' %>">
        Next
      </a>
    <% } %>
  </div>
</section>
<% } else { %>
<!-- ============================= -->
<!-- USER VIEW: ANSWERED SURVEYS   -->
<!-- ============================= -->
<section>
  <h2>Answered Surveys</h2>
  <% if (!answeredSurveys || answeredSurveys.length === 0) { %>
    <p>No answered surveys yet.</p>
  <% } else { %>
    <table>
      <thead>
        <tr>
          <th>Event Name</th>
          <th>Event Start</th>
          <th>Location</th>
          <th>Attendance</th>
          <th>Satisfaction</th>
          <th>Usefulness</th>
          <th>Instructor</th>
          <th>Recommendation</th>
          <th>Overall</th>
          <th>Submitted At</th>
        </tr>
      </thead>
      <tbody>
      <% answeredSurveys.forEach(function(s) { %>
        <tr>
          <td><%= s.eventname %></td>
          <td><%= s.eventdatetimestart ? new Date(s.eventdatetimestart).toLocaleString() : 'N/A' %></td>
          <td><%= s.eventlocation || 'N/A' %></td>
          <td><%= s.registrationattendanceflag ? 'Yes' : 'No' %></td>
          <td><%= s.surveysatisfactionscore %></td>
          <td><%= s.surveyusefulnessscore %></td>
          <td><%= s.surveyinstructorscore %></td>
          <td><%= s.surveyrecommendationscore %></td>
          <td><%= s.surveyoverallscore %></td>
          <td>
            <% if (s.surveysubmissiondate) { %>
              <%= new Date(s.surveysubmissiondate).toLocaleString() %>
            <% } else { %> N/A <% } %>
          </td>
        </tr>
      <% }); %>
      </tbody>
    </table>
  <% } %>
</section>

<hr>

<!-- ============================= -->
<!-- USER VIEW: PENDING SURVEYS    -->
<!-- ============================= -->
<section>
  <h2>Pending Surveys (attended, not submitted)</h2>
  <% if (!pendingSurveys || pendingSurveys.length === 0) { %>
    <p>No pending surveys right now.</p>
  <% } else { %>
    <table>
      <thead>
        <tr>
          <th>Event Name</th>
          <th>Event Start</th>
          <th>Location</th>
          <th>Attendance</th>
          <th>Survey Link</th>
        </tr>
      </thead>
      <tbody>
      <% pendingSurveys.forEach(function(p) { %>
        <tr>
          <td><%= p.eventname %></td>
          <td><%= p.eventdatetimestart ? new Date(p.eventdatetimestart).toLocaleString() : 'N/A' %></td>
          <td><%= p.eventlocation || 'N/A' %></td>
          <td><%= p.registrationattendanceflag ? 'Yes' : 'No' %></td>
          <td>
            <a href="<%= surveyFormUrl %>" target="_blank" rel="noopener noreferrer">Open Survey Form</a>
          </td>
        </tr>
      <% }); %>
      </tbody>
    </table>
  <% } %>
</section>
<% } %>

</main>
</div>
</body>
</html>
