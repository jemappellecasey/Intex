<!DOCTYPE html>
<html lang="en">
<head>
  <title>Edit Participant</title>
  <%- include('partials/head') %>
</head>
<body>
<div class="layout">
  <%- include('partials/userbar') %>
  <%- include('partials/sidebar', { active: 'participants' }) %>
  <main class="main">

  <h1>Edit Participant</h1>
  <p><a href="/participants" class="btn">Back to Participants</a></p>

  <% if (validationErrors && validationErrors.length) { %>
    <div class="alert alert-error">
      <ul>
        <% validationErrors.forEach(function(msg) { %>
          <li><%= msg %></li>
        <% }) %>
      </ul>
    </div>
  <% } %>

  <% if (error_message) { %>
    <div class="alert alert-error"><%= error_message %></div>
  <% } %>

  <% if (typeof success_message !== 'undefined' && success_message) { %>
    <div class="alert alert-success"><%= success_message %></div>
  <% } %>

  <!-- Editable participant information (only for manager users) -->
  <section>
    <h2>Basic Information</h2>

    <form method="post" action="/participants/<%= participant.participantid %>/edit">
      <input type="hidden" name="_csrf" value="<%= csrfToken %>">

      <table class="form-table compact">
        <tr>
          <th>Email</th>
          <td>
            <input type="email" name="email" value="<%= participant.email || '' %>" required>
          </td>
        </tr>

        <tr>
          <th>First Name</th>
          <td>
            <input type="text" name="participantfirstname" value="<%= participant.participantfirstname || '' %>" required>
          </td>
        </tr>

        <tr>
          <th>Last Name</th>
          <td>
            <input type="text" name="participantlastname" value="<%= participant.participantlastname || '' %>" required>
          </td>
        </tr>

        <tr>
          <th>Date of Birth</th>
          <td>
            <input type="date" name="participantdob"
              value="<% if (participant.participantdob) { %>
                       <%= participant.participantdob.toISOString
                            ? participant.participantdob.toISOString().slice(0,10)
                            : participant.participantdob %>
                     <% } %>">
          </td>
        </tr>

        <tr>
          <th>Role</th>
          <td>
            <input type="text" name="participantrole" value="<%= participant.participantrole || '' %>">
          </td>
        </tr>

        <tr>
          <th>Phone Number</th>
          <td>
            <input type="text" name="participantphone" value="<%= participant.participantphone || '' %>">
          </td>
        </tr>

        <tr>
          <th>City</th>
          <td>
            <input type="text" name="participantcity" value="<%= participant.participantcity || '' %>">
          </td>
        </tr>

        <tr>
          <th>State</th>
          <td>
            <input type="text" name="participantstate" value="<%= participant.participantstate || '' %>">
          </td>
        </tr>

        <tr>
          <th>Zip</th>
          <td>
            <input type="text" name="participantzip" value="<%= participant.participantzip || '' %>">
          </td>
        </tr>

        <tr>
          <th>Field of Interest</th>
          <td>
            <input type="text" name="participantfieldofinterest" value="<%= participant.participantfieldofinterest || '' %>">
          </td>
        </tr>
      </table>

      <div class="form-actions centered">
        <button type="submit" class="btn">Save Changes</button>
        <a href="/participants/<%= participant.participantid %>" class="btn secondary-btn" style="margin-left:8px;">Cancel</a>
      </div>
    </form>
  </section>

  <hr>

  <!-- Display-only summary information (same content as viewParticipant.ejs) -->
  <section>
    <h2>Summary</h2>
    <div class="summary-cards">
      <div class="summary-card">
        <p class="summary-label">First Registration</p>
        <p class="summary-value">
          <% if (firstRegistration) { %>
            <%= (new Date(firstRegistration)).toISOString().slice(0, 10) %>
          <% } else { %> N/A <% } %>
        </p>
      </div>
      <div class="summary-card">
        <p class="summary-label">Latest Registration</p>
        <p class="summary-value">
          <% if (lastRegistration) { %>
            <%= (new Date(lastRegistration)).toISOString().slice(0, 10) %>
          <% } else { %> N/A <% } %>
        </p>
      </div>
      <div class="summary-card">
        <p class="summary-label">Total Surveys</p>
        <p class="summary-value"><%= surveyCount %></p>
      </div>
      <div class="summary-card">
        <p class="summary-label">Average Overall Survey Score</p>
        <p class="summary-value">
          <% if (avgOverallScore) { %>
            <%= Number(avgOverallScore).toFixed(2) %>
          <% } else { %> N/A <% } %>
        </p>
      </div>
    </div>
  </section>

  <hr>

  <!-- Event history (read-only) -->
<section>
  <h2>Event History</h2>
  <% if (events && events.length > 0) { %>
    <table>
      <thead>
        <tr>
          <th>Event Title</th>
          <th>Event Type</th>
          <th>Start Date/Time</th>
          <th>Registration Status</th>
          <th>Check-in Time</th>
          <th>Attendance Flag</th>
          <th>Registration Created At</th>
          <% if (isManager) { %><th>Actions</th><% } %>
        </tr>
      </thead>

      <tbody>
      <% events.forEach(function(ev) { %>
        <tr>
          <td><%= ev.eventtitle %></td>
          <td><%= ev.eventtype %></td>

          <td>
            <% if (ev.eventdatetimestart) { %>
              <%= (new Date(ev.eventdatetimestart))
                    .toISOString().slice(0, 16).replace('T', ' ') %>
            <% } else { %> N/A <% } %>
          </td>

          <td>
            <% if (isManager) { %>
              <form method="post" action="/participants/<%= participant.participantid %>/registrations/<%= ev.registrationid %>">
                <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                <input type="text" name="registrationstatus" value="<%= ev.registrationstatus || '' %>">
            <% } else { %>
              <%= ev.registrationstatus || '' %>
            <% } %>
          </td>

          <td>
            <% if (ev.registrationcheckintime) { %>
              <%= (new Date(ev.registrationcheckintime))
                    .toISOString().slice(0, 16).replace('T', ' ') %>
            <% } else { %> N/A <% } %>
          </td>

          <td>
              <% if (isManager) { %>
                <input
                  type="checkbox"
                  name="registrationattendanceflag"
                  value="1"
                  <%= ev.registrationattendanceflag ? 'checked' : '' %>
                >
              <% } else { %>
                <%= ev.registrationattendanceflag ? 'Yes' : 'No' %>
              <% } %>
          </td>

          <td>
            <% if (ev.registrationcreatedat) { %>
              <%= (new Date(ev.registrationcreatedat))
                    .toISOString().slice(0, 16).replace('T', ' ') %>
            <% } else { %> N/A <% } %>
          </td>

          <% if (isManager) { %>
            <td>
                <button type="submit">Save</button>
              </form>
            </td>
          <% } %>
        </tr>
      <% }); %>
      </tbody>
    </table>
  <% } else { %>
    <p>No event history found for this participant.</p>
  <% } %>
</section>


  <hr>

<section>
  <h2>Post-Event Surveys</h2>

  <% if (surveys && surveys.length > 0) { %>
    <table>
      <thead>
        <tr>
          <th>Event Title</th>
          <th>Event Start</th>
          <th>Satisfaction</th>
          <th>Usefulness</th>
          <th>Instructor</th>
          <th>Recommendation</th>
          <th>Overall</th>
          <th>Submission Date</th>
          <% if (isManager) { %><th>Actions</th><% } %>
        </tr>
      </thead>

      <tbody>
      <% surveys.forEach(function(s) { %>
        <tr>
          <td><%= s.eventtitle %></td>

          <td>
            <% if (s.eventdatetimestart) { %>
              <%= (new Date(s.eventdatetimestart))
                    .toISOString().slice(0, 16).replace('T', ' ') %>
            <% } else { %> N/A <% } %>
          </td>

          <% if (isManager) { %>
            <form method="post" action="/participants/<%= participant.participantid %>/surveys/<%= s.surveyid %>">
              <input type="hidden" name="_csrf" value="<%= csrfToken %>">

              <td>
                <input type="number" name="surveysatisfactionscore" value="<%= s.surveysatisfactionscore || '' %>">
              </td>

              <td>
                <input type="number" name="surveyusefulnessscore" value="<%= s.surveyusefulnessscore || '' %>">
              </td>

              <td>
                <input type="number" name="surveyinstructorscore" value="<%= s.surveyinstructorscore || '' %>">
              </td>

              <td>
                <input type="number" name="surveyrecommendationscore" value="<%= s.surveyrecommendationscore || '' %>">
              </td>

              <td>
                <input type="number" name="surveyoverallscore" value="<%= s.surveyoverallscore || '' %>">
              </td>

              <td>
                <% if (s.surveysubmissiondate) { %>
                  <%= (new Date(s.surveysubmissiondate))
                        .toISOString().slice(0, 16).replace('T', ' ') %>
                <% } else { %> N/A <% } %>
              </td>

              <td>
                <button type="submit">Save</button>
              </td>
            </form>
          <% } else { %>
            <td><%= s.surveysatisfactionscore || '' %></td>
            <td><%= s.surveyusefulnessscore || '' %></td>
            <td><%= s.surveyinstructorscore || '' %></td>
            <td><%= s.surveyrecommendationscore || '' %></td>
            <td><%= s.surveyoverallscore || '' %></td>
            <td>
              <% if (s.surveysubmissiondate) { %>
                <%= (new Date(s.surveysubmissiondate))
                      .toISOString().slice(0, 16).replace('T', ' ') %>
              <% } else { %> N/A <% } %>
            </td>
          <% } %>
        </tr>
      <% }); %>
      </tbody>
    </table>

  <% } else { %>
    <p>No surveys recorded for this participant.</p>
  <% } %>
</section>

  <hr>

  <!-- Milestones (read-only) -->
 <section>
  <h2>Milestones</h2>

  <% if (milestones && milestones.length > 0) { %>
    <table>
      <thead>
        <tr>
          <th>Title</th>
          <th>Date</th>
          <% if (isManager) { %><th>Actions</th><% } %>
        </tr>
      </thead>

      <tbody>
      <% milestones.forEach(function(m) { %>
        <tr>
          <% if (isManager) { %>
            <form method="post" action="/participants/<%= participant.participantid %>/milestones/<%= m.milestoneid %>">
              <input type="hidden" name="_csrf" value="<%= csrfToken %>">

              <td>
                <input type="text" name="milestonetitle" value="<%= m.milestonetitle || '' %>">
              </td>

              <td>
                <input
                  type="date"
                  name="milestonedate"
                  value="<% if (m.milestonedate) { %>
                           <%= (new Date(m.milestonedate)).toISOString().slice(0, 10) %>
                         <% } %>"
                >
              </td>

              <td>
                <button type="submit">Save</button>
              </td>
            </form>
          <% } else { %>
            <td><%= m.milestonetitle || '' %></td>
            <td>
              <% if (m.milestonedate) { %>
                <%= (new Date(m.milestonedate)).toISOString().slice(0, 10) %>
              <% } else { %> N/A <% } %>
            </td>
          <% } %>
        </tr>
      <% }); %>
      </tbody>
    </table>

  <% } else { %>
    <p>No milestones recorded for this participant.</p>
  <% } %>
</section>


  <hr>

<section>
  <h2>Donations</h2>

  <% if (donations && donations.length > 0) { %>
    <table>
      <thead>
        <tr>
          <th>Date</th>
          <th>Amount</th>
          <% if (isManager) { %><th>Actions</th><% } %>
        </tr>
      </thead>

      <tbody>
      <% donations.forEach(function(d) { %>
        <tr>
          <% if (isManager) { %>
            <form method="post" action="/participants/<%= participant.participantid %>/donations/<%= d.donationid %>">
              <input type="hidden" name="_csrf" value="<%= csrfToken %>">

              <td>
                <input
                  type="date"
                  name="donationdate"
                  value="<% if (d.donationdate) { %>
                           <%= (new Date(d.donationdate)).toISOString().slice(0, 10) %>
                         <% } %>"
                >
              </td>

              <td>
                <input
                  type="number"
                  step="0.01"
                  name="donationamount"
                  value="<%= d.donationamount || '' %>"
                >
              </td>

              <td>
                <button type="submit">Save</button>
              </td>
            </form>
          <% } else { %>
            <td>
              <% if (d.donationdate) { %>
                <%= (new Date(d.donationdate)).toISOString().slice(0, 10) %>
              <% } else { %> N/A <% } %>
            </td>
            <td><%= d.donationamount || '' %></td>
          <% } %>
        </tr>
      <% }); %>
      </tbody>
    </table>

  <% } else { %>
    <p>No donations recorded for this participant.</p>
  <% } %>
</section>


  </main>
</div>
</body>
</html>
