<!DOCTYPE html>
<html lang="en">
<head>
  <title>Events</title>
  <%- include('partials/head') %>
</head>
<body>
<div class="layout">
  <aside class="sidebar">
    <div class="sidebar-brand">
      <a href="/dashboard" aria-label="Back to dashboard">
        <img src="/images/logo.png" alt="Ella Rises logo" class="brand-logo">
      </a>
    </div>
    <h2>Menu</h2>
    <nav>
      <a href="/dashboard">Dashboard</a>
      <a href="/participants">Participants</a>
      <a href="/events" class="active">Events</a>
      <a href="/surveys">Surveys</a>
      <a href="/milestones">Milestones</a>
      <a href="/donations">Donations</a>
      <% if (isManager) { %>
        <hr>
        <a href="/admin/settings">Admin Settings</a>
      <% } %>
    </nav>
  </aside>
<main class="main-content">

<h1>Events</h1>

<!-- Error message -->
<% if (error_message) { %>
  <div class="alert alert-error"><%= error_message %></div>
<% } %>

<!-- ============================= -->
<!-- SEARCH / FILTER SECTION       -->
<!-- ============================= -->
<% if (isManager) { %>
  <section>
    <h2>Search Events</h2>
    <form method="get" action="/events">
      <label>
        Event Name:
        <input type="text" name="name" value="<%= name || '' %>">
      </label>

      <label>
        Start Date:
        <input type="date" name="startDate" value="<%= startDate || '' %>">
      </label>

      <label>
        End Date:
        <input type="date" name="endDate" value="<%= endDate || '' %>">
      </label>

      <button type="submit">Search</button>
    </form>
  </section>

  <hr>
  <section style="margin-top: 12px;">
    <h2>Manager Tools</h2>

    <p>
      <a href="/events/new">
        <button type="button">Add New Event</button>
      </a>
    </p>
  </section>
<% } %>

<!-- ============================= -->
<!-- UPCOMING EVENTS (25 per page) -->
<!-- ============================= -->
<section>
  <h2>Upcoming Events</h2>

  <div>
    <% if (upcomingCurrentPage > 1) { %>
      <a href="/events?upcomingPage=<%= upcomingCurrentPage - 1 %>&pastPage=<%= pastCurrentPage %>&name=<%= name %>&startDate=<%= startDate %>&endDate=<%= endDate %>">
        Prev Upcoming
      </a>
    <% } %>

    <span>Page <%= upcomingCurrentPage %> of <%= upcomingTotalPages %></span>

    <% if (upcomingCurrentPage < upcomingTotalPages) { %>
      <a href="/events?upcomingPage=<%= upcomingCurrentPage + 1 %>&pastPage=<%= pastCurrentPage %>&name=<%= name %>&startDate=<%= startDate %>&endDate=<%= endDate %>">
        Next Upcoming
      </a>
    <% } %>
  </div>

  <% if (!upcomingEvents || upcomingEvents.length === 0) { %>
    <p>No upcoming events found.</p>
  <% } else { %>
    <table>
      <thead>
      <tr>
        <th>Name</th>
        <th>Description</th>
        <th>Location</th>
        <th>Start</th>
        <th>End</th>
        <th>Capacity</th>
        <th>Registered</th>
        <th>Deadline</th>
        <th>Action</th>
        <% if (isManager) { %>
          <th>Edit</th>
          <th>Delete</th>
        <% } %>
      </tr>
      </thead>

      <tbody>
      <% upcomingEvents.forEach(function(ev) { %>
        <tr>
          <td><%= ev.eventname %></td>
          <td><%= ev.eventdescription || 'N/A' %></td>
          <td><%= ev.eventlocation || 'N/A' %></td>

          <td>
            <% if (ev.eventdatetimestart) { %>
              <%= new Date(ev.eventdatetimestart).toLocaleString() %>
            <% } else { %> N/A <% } %>
          </td>

          <td>
            <% if (ev.eventdatetimeend) { %>
              <%= new Date(ev.eventdatetimeend).toLocaleString() %>
            <% } else { %> N/A <% } %>
          </td>

          <td><%= ev.eventcapacity %></td>
          <td>
            <% if (!isManager && ev.selfregistrationstatus) { %>
              Registered
            <% } else { %>
              <%= ev.registeredcount %>
            <% } %>
          </td>

          <td>
            <% if (ev.eventregistrationdeadline) { %>
              <%= new Date(ev.eventregistrationdeadline).toLocaleString() %>
            <% } else { %> N/A <% } %>
          </td>

          <td>
            <% const isFull = ev.eventcapacity !== null
                              && ev.eventcapacity !== undefined
                              && Number(ev.registeredcount) >= Number(ev.eventcapacity); %>

            <% if (ev.isregisteredforcurrentuser) { %>
              <div class="mt-1">
                <span class="text-muted">You are registered</span>
                <form method="post" action="/events/<%= ev.eventdetailsid %>/unregister" style="display:inline;">
                  <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                  <button type="submit" class="btn" style="margin-left:6px;">Unregister</button>
                </form>
              </div>
            <% } else if (isFull) { %>
              <strong style="color:red;">This event is fully booked</strong>
            
            <% } else { %>
              <form method="get" action="/events/<%= ev.eventdetailsid %>/register">
                <button type="submit">Register</button>
              </form>
            <% } %>
          </td>


          <% if (isManager) { %>
            <!-- Edit button (manager only) -->
            <td>
              <a href="/events/<%= ev.eventdetailsid %>/edit">
                <button type="button">Edit</button>
              </a>
            </td>

            <!-- Delete button (manager only) -->
            <td>
              <form method="post" action="/events/<%= ev.eventdetailsid %>/delete"
                    onsubmit="return confirm('Are you sure you want to delete this event?');">
                <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                <button type="submit">Delete</button>
              </form>
            </td>
          <% } %>
        </tr>
      <% }); %>
      </tbody>
    </table>
  <% } %>
</section>

<hr>

<!-- ============================= -->
<!-- PAST EVENTS (25 per page)    -->
<!-- ============================= -->
<section>
  <h2>Past Events</h2>

  <div>
    <% if (pastCurrentPage > 1) { %>
      <a href="/events?upcomingPage=<%= upcomingCurrentPage %>&pastPage=<%= pastCurrentPage - 1 %>&name=<%= name %>&startDate=<%= startDate %>&endDate=<%= endDate %>">
        Prev Past
      </a>
    <% } %>

    <span>Page <%= pastCurrentPage %> of <%= pastTotalPages %></span>

    <% if (pastCurrentPage < pastTotalPages) { %>
      <a href="/events?upcomingPage=<%= upcomingCurrentPage %>&pastPage=<%= pastCurrentPage + 1 %>&name=<%= name %>&startDate=<%= startDate %>&endDate=<%= endDate %>">
        Next Past
      </a>
    <% } %>
  </div>

  <% if (!pastEvents || pastEvents.length === 0) { %>
    <p>No past events found.</p>
  <% } else { %>
    <table>
      <thead>
      <tr>
        <th>Name</th>
        <th>Location</th>
        <th>Start</th>
        <th>End</th>
        <th>Capacity</th>
        <th>Registered</th>
        <th>Attended</th>
        <% if (isManager) { %>
          <th>Edit</th>
          <th>Delete</th>
        <% } %>
      </tr>
      </thead>
      <tbody>
      <% pastEvents.forEach(function(ev) { %>
        <tr>
          <td><%= ev.eventname %></td>
          <td><%= ev.eventlocation || 'N/A' %></td>

          <td>
            <% if (ev.eventdatetimestart) { %>
              <%= new Date(ev.eventdatetimestart).toLocaleString() %>
            <% } else { %> N/A <% } %>
          </td>

          <td>
            <% if (ev.eventdatetimeend) { %>
              <%= new Date(ev.eventdatetimeend).toLocaleString() %>
            <% } else { %> N/A <% } %>
          </td>

          <td><%= ev.eventcapacity %></td>
          <td>
            <% if (!isManager && ev.selfregistrationstatus) { %>
              Registered
            <% } else { %>
              <%= ev.registeredcount %>
            <% } %>
          </td>
          <td><%= ev.attendedcount %></td>

          <% if (isManager) { %>
            <td>
              <a href="/events/<%= ev.eventdetailsid %>/edit">
                <button type="button">Edit</button>
              </a>
            </td>
            <td>
              <form method="post" action="/events/<%= ev.eventdetailsid %>/delete"
                    onsubmit="return confirm('Are you sure you want to delete this event?');">
                <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                <button type="submit">Delete</button>
              </form>
            </td>
          <% } %>
        </tr>
      <% }); %>
      </tbody>
    </table>
  <% } %>
</section>

<hr>

</main>
</div>
</body>
</html>
