<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Donations</title>
</head>
<body>

<h1>Donations</h1>
<p><a href="/dashboard">Back to Dashboard</a></p>

<% if (error_message) { %>
  <p style="color:red;"><%= error_message %></p>
<% } %>

<% if (!isAdmin) { %>
  <p>Thank you for your donations!</p>
<% } %>

<p><strong>Total Amount:</strong> $<%= (totalAmount || 0).toFixed(2) %></p>

<% if (isAdmin) { %>
  <section>
    <h2>Search Donations</h2>
    <form method="get" action="/donations">
      <label>
        Name:
        <input type="text" name="name" value="<%= name || '' %>">
      </label>
      <label>
        Email:
        <input type="text" name="email" value="<%= email || '' %>">
      </label>
      <label>
        Start Date:
        <input type="date" name="startDate" value="<%= startDate || '' %>">
      </label>
      <label>
        End Date:
        <input type="date" name="endDate" value="<%= endDate || '' %>">
      </label>
      <button type="submit">Search</button>
    </form>
  </section>
  <hr>
<% } %>

<p>
  <a href="/donations/new"><button type="button">Add Donation</button></a>
</p>

<section>
  <h2>Donation List</h2>

  <div>
    <% if (currentPage > 1) { %>
      <a href="/donations?page=<%= currentPage - 1 %>&name=<%= encodeURIComponent(name || '') %>&email=<%= encodeURIComponent(email || '') %>&startDate=<%= startDate || '' %>&endDate=<%= endDate || '' %>">Prev</a>
    <% } %>
    <span>Page <%= currentPage %> of <%= totalPages %></span>
    <% if (currentPage < totalPages) { %>
      <a href="/donations?page=<%= currentPage + 1 %>&name=<%= encodeURIComponent(name || '') %>&email=<%= encodeURIComponent(email || '') %>&startDate=<%= startDate || '' %>&endDate=<%= endDate || '' %>">Next</a>
    <% } %>
  </div>

  <% if (!donations || donations.length === 0) { %>
    <p>No donations found.</p>
  <% } else { %>
    <table border="1" cellspacing="0" cellpadding="4">
      <thead>
        <tr>
          <% if (isAdmin) { %>
            <th>Donor</th>
            <th>Email</th>
          <% } %>
          <th>Donation Date</th>
          <th>Amount</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
      <% donations.forEach(function(d) { %>
        <tr>
          <% if (isAdmin) { %>
            <td><%= d.participantfirstname %> <%= d.participantlastname %></td>
            <td><%= d.email || 'N/A' %></td>
          <% } %>
          <td><%= d.donationdate ? new Date(d.donationdate).toISOString().slice(0,10) : 'N/A' %></td>
          <td>$<%= d.donationamount ? Number(d.donationamount).toFixed(2) : '0.00' %></td>
          <td>
            <% if (isAdmin || (selfParticipantId && Number(selfParticipantId) === Number(d.participantid))) { %>
              <a href="/donations/<%= d.donationid %>/edit"><button type="button">Edit</button></a>
              <% if (isAdmin) { %>
                <form method="post" action="/donations/<%= d.donationid %>/delete" style="display:inline;">
                  <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                  <button type="submit" onclick="return confirm('Delete this donation?');">Delete</button>
                </form>
              <% } %>
            <% } %>
          </td>
        </tr>
      <% }); %>
      </tbody>
    </table>
  <% } %>
</section>

</body>
</html>
