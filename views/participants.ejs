<!-- Participants list page -->
<!-- done, Lists all participants. 
 (step 2 needs to work on.)On dropdown of participant show their attended 
 and registered events as well as any corresponding survey results 
 (show the overall score or NPS bucket, on hover or drop down show every score) --> 
<!-- Include filters for event name and type. 
 Then show only the participants for those things, 
 (keep the dropdown showing their other attended events?) --> 
 <!-- for each participant include a link to the view participant page -->
<!DOCTYPE html>
<html lang="en">
<head>
  <title>Participants</title>
  <%- include('partials/head') %>
</head>
<body>
<div class="layout">
  <%- include('partials/userbar') %>
  <aside class="sidebar">
    <div class="sidebar-brand">
      <a href="/dashboard" aria-label="Back to dashboard">
        <img src="/images/logo.png" alt="Ella Rises logo" class="brand-logo">
      </a>
    </div>
    <h2>Menu</h2>
    <nav>
      <a href="/dashboard">Dashboard</a>
      <a href="/participants" class="active">Participants</a>
      <a href="/events">Events</a>
      <a href="/surveys">Surveys</a>
      <a href="/milestones">Milestones</a>
      <a href="/donations">Donations</a>
      <% if (isManager) { %>
        <hr>
        <a href="/admin/settings">Admin Settings</a>
      <% } %>
    </nav>
  </aside>
  <main class="main-content">

  <h1>Participants</h1>

  <!-- Error / flash message (optional) -->
  <% if (validationErrors && validationErrors.length) { %>
    <div class="alert alert-error">
      <ul>
        <% validationErrors.forEach(function(msg) { %>
          <li><%= msg %></li>
        <% }) %>
      </ul>
    </div>
  <% } %>

  <% if (error_message) { %>
    <div class="alert alert-error"><%= error_message %></div>
  <% } %>


  <!-- Filter form: event + basic participant info -->
  <% if (isManager) { %>
    <div class="page-actions">
      <a href="/participants/add">
        <button type="button">Add New Participant</button>
      </a>
    </div>
    <h2 class="centered-title">Search Participant</h2>
    <form method="get" action="/participants" class="filter-form">
      <div class="compact-field">
        <label>
          Milestone Title:
          <input
            type="text"
            name="milestoneTitle"
            value="<%= typeof milestoneTitle !== 'undefined' ? milestoneTitle : '' %>">
        </label>
      </div>

      <div class="compact-field">
        <label>
          Name:
          <input
            type="text"
            name="name"
            value="<%= typeof name !== 'undefined' ? name : '' %>">
        </label>
      </div>

      <div class="compact-field">
        <label>
          Email:
          <input
            type="text"
            name="email"
            value="<%= typeof email !== 'undefined' ? email : '' %>">
        </label>
      </div>

      <div class="compact-field">
        <label>
          Phone:
          <input
            type="text"
            name="phone"
            value="<%= typeof phone !== 'undefined' ? phone : '' %>">
        </label>
      </div>

      <div class="filter-actions">
        <button type="submit">Filter</button>
      </div>
    </form>



    <hr>
  <% } %>

  <!-- Participants list -->
  <table class="<%= isManager ? 'participants-table' : 'participants-table push-down' %>">
    <thead>
      <tr>
        <th>First Name</th>
        <th>Last Name</th>
        <th>Date of Birth</th>
        <th>Phone Number</th>
        <th>Field of Interest</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      <% if (participants && participants.length > 0) { %>
        <% for (let iCount = 0; iCount < participants.length; iCount++) {
            let p = participants[iCount];
        %>
          <tr>
            <td><%= p.participantfirstname %></td>
            <td><%= p.participantlastname %></td>
            <td>
              <% if (p.participantdob && p.participantdob.toISOString) { %>
                <%= p.participantdob.toISOString().slice(0, 10) %>
              <% } else { %>
                <%= p.participantdob %>
              <% } %>
            </td>
            <td><%= p.participantphone %></td>
            <td><%= p.participantfieldofinterest %></td>
            <td>
              <% if (isManager || (selfParticipantId && Number(selfParticipantId) === Number(p.participantid))) { %>
                <a href="/participants/<%= p.participantid %>/edit">Edit</a>
                <% if (isManager) { %>
                  |
                  <form action="/deleteparticipants/<%= p.participantid %>" method="POST"
                        style="display:inline;">
                    <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                    <button type="submit"
                            onclick="return confirm('Delete this participant?');">
                      Delete
                    </button>
                  </form>
                <% } %>
              <% } %>

              <details style="margin-top: 4px;">
                <summary>Quick view</summary>
                <ul>
                  <li>Email: <%= p.email %></li>
                  <li>Role: <%= p.participantrole %></li>
                  <li>City/State: <%= p.participantcity %>, <%= p.participantstate %></li>
                  <li>
                    Milestones:
                    <% if (p.milestones && p.milestones.trim() !== '') { %>
                      <%= p.milestones %>
                    <% } else { %>
                      <span>No milestones recorded yet</span>
                    <% } %>
                  </li>
                </ul>
                <p style="margin-top: 4px;">
                  <a href="/participants/<%= p.participantid %>">Open full details â†’</a>
                </p>
              </details>
            </td>
          </tr>
        <% } %>
      <% } else { %>
        <tr>
          <td colspan="7">No participants found.</td>
        </tr>
      <% } %>
    </tbody>
  </table>

  <div class="pagination pagination-centered" style="margin-top: 16px;">
    <% if (currentPage > 1) { %>
      <a class="btn secondary-btn" href="/participants?page=<%= currentPage - 1 %>">Prev</a>
    <% } %>

    <span>Page <%= currentPage %> of <%= totalPages %></span>

    <% if (currentPage < totalPages) { %>
      <a class="btn secondary-btn" href="/participants?page=<%= currentPage + 1 %>">Next</a>
    <% } %>
  </div>

</main>
</div>
</body>
</html>
