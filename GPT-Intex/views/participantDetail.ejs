<!-- FILE: views/participantDetail.ejs -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Participant Profile - Ella Rises</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
  <nav class="navbar">
    <div class="nav-container">
      <div class="nav-brand">üéµ Ella Rises</div>
      <ul class="nav-menu">
        <li><a href="/dashboard">Dashboard</a></li>
        <li><a href="/participants">Participants</a></li>
        <li><a href="/logout">Logout</a></li>
      </ul>
    </div>
  </nav>
  <main class="main-container">
    <% if (error_message) { %>
      <div class="alert alert-error">‚ùå <%= error_message %></div>
    <% } %>
    <% if (success_message) { %>
      <div class="alert alert-success">‚úÖ <%= success_message %></div>
    <% } %>
    <div class="container">
      <div class="page-header">
        <h1><%= participant.participant_first_name %> <%= participant.participant_last_name %></h1>
        <% if (isManager) { %>
          <a href="/participants/<%= participant.id %>/edit" class="btn btn-primary">Edit Profile</a>
        <% } %>
      </div>
      
      <div class="participant-profile">
        <section class="profile-section">
          <h2>Contact Information</h2>
          <div class="profile-grid">
            <div><strong>Email:</strong> <%= participant.email %></div>
            <div><strong>Phone:</strong> <%= participant.participant_phone || 'N/A' %></div>
            <div><strong>City:</strong> <%= participant.participant_city || 'N/A' %></div>
            <div><strong>State:</strong> <%= participant.participant_state || 'N/A' %></div>
            <div><strong>ZIP Code:</strong> <%= participant.participant_zip || 'N/A' %></div>
            <div><strong>Role:</strong> <%= participant.participant_role || 'N/A' %></div>
            <div><strong>Field of Interest:</strong> <%= participant.participant_field_of_interest || 'N/A' %></div>
            <div><strong>Total Donations:</strong> $<%= parseFloat(participant.total_donations || 0).toFixed(2) %></div>
          </div>
        </section>

        <section class="profile-section">
          <div class="section-header">
            <h2>Milestones</h2>
            <% if (isManager) { %>
              <button class="btn btn-small" onclick="document.getElementById('addMilestoneForm').style.display = document.getElementById('addMilestoneForm').style.display === 'none' ? 'block' : 'none'">+ Add Milestone</button>
            <% } %>
          </div>
          
          <% if (isManager) { %>
            <form id="addMilestoneForm" method="POST" action="/participants/<%= participant.id %>/milestones/add" class="form form-inline" style="display:none;">
              <input type="hidden" name="_csrf" value="<%= csrfToken %>">
              <input type="text" name="title" placeholder="Milestone title" required>
              <input type="date" name="date">
              <button type="submit" class="btn btn-small">Save</button>
            </form>
          <% } %>

          <% if (milestones && milestones.length > 0) { %>
            <ul class="milestone-list">
              <% milestones.forEach(m => { %>
                <li>
                  <span class="milestone-title"><%= m.milestone_title %></span>
                  <span class="milestone-date"><%= new Date(m.milestone_date || m.created_at).toLocaleDateString() %></span>
                  <% if (isManager) { %>
                    <form method="post" action="/milestones/<%= m.id %>/delete" style="display:inline;">
                      <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                      <button type="submit" class="btn btn-small btn-danger" onclick="return confirm('Delete milestone?');">Delete</button>
                    </form>
                  <% } %>
                </li>
              <% }); %>
            </ul>
          <% } else { %>
            <p class="text-muted">No milestones awarded</p>
          <% } %>
        </section>

        <section class="profile-section">
          <h2>Event History</h2>
          <% if (registrations && registrations.length > 0) { %>
            <ul class="activity-list">
              <% registrations.forEach(r => { %>
                <li>
                  <strong><%= r.event_name %></strong>
                  <span class="text-muted"><%= new Date(r.event_date_time_start).toLocaleDateString() %></span>
                </li>
              <% }); %>
            </ul>
          <% } else { %>
            <p class="text-muted">No events registered</p>
          <% } %>
        </section>

        <section class="profile-section">
          <h2>Surveys Submitted</h2>
          <% if (surveys && surveys.length > 0) { %>
            <p><strong><%= surveys.length %></strong> surveys submitted</p>
          <% } else { %>
            <p class="text-muted">No surveys submitted</p>
          <% } %>
        </section>

        <section class="profile-section">
          <h2>Donations</h2>
          <% if (donations && donations.length > 0) { %>
            <p><strong><%= donations.length %></strong> donations | Total: <strong>$<%= donations.reduce((sum, d) => sum + parseFloat(d.donation_amount), 0).toFixed(2) %></strong></p>
          <% } else { %>
            <p class="text-muted">No donations recorded</p>
          <% } %>
        </section>
      </div>
      
      <a href="/participants" class="btn btn-secondary">‚Üê Back to Participants</a>
    </div>
  </main>
  <footer class="footer">
    <p>&copy; 2025 Ella Rises</p>
  </footer>
</body>
</html>
